name: Auto Merge Trusted PRs

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write

jobs:
  enable-auto-merge:
    runs-on: ubuntu-latest
    # Check if the PR author is a Bot OR has high privileges (Owner, Admin, Maintainer)
    if: |
      github.event.pull_request.user.type == 'Bot' ||
      contains(fromJSON('["OWNER", "ADMIN", "MAINTAINER", "COLLABORATOR"]'), github.event.pull_request.author_association)
    steps:
      - name: Enable Auto-Merge for PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        # Logic:
        # --auto: Queues the merge to happen only after requirements (tests/checks) are met.
        # --squash: Squashes commits into one (cleaner history). Change to --merge or --rebase if preferred.
        run: |
          echo "Processing PR: $PR_URL"
          echo "Author Association: ${{ github.event.pull_request.author_association }}"

          set +e
          # Retry loop parameters
          MAX_RETRIES=5
          RETRY_DELAY=10
          COUNT=0
          SUCCESS=0

          while [ $COUNT -lt $MAX_RETRIES ]; do
            OUTPUT=$(gh pr merge "$PR_URL" --auto --squash 2>&1)
            EXIT_CODE=$?

            if [ $EXIT_CODE -eq 0 ]; then
              echo "✅ Auto-merge enabled successfully"
              SUCCESS=1
              break
            fi

            # Check if it's the specific "unstable status" error which is worth retrying
            if echo "$OUTPUT" | grep -q "Pull request is in unstable status"; then
              echo "⚠️  Attempt $(($COUNT + 1))/$MAX_RETRIES failed: PR is in unstable status. Retrying in ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
              COUNT=$(($COUNT + 1))
            else
              # For other errors, we might want to fail immediately or check for protected branch rules
              if echo "$OUTPUT" | grep -q "Protected branch rules not configured"; then
                 echo "⚠️  Auto-merge is not available: Protected branch rules not configured for this branch"
                 echo "This is expected if branch protection doesn't allow auto-merge. The PR will need manual merge."
                 exit 0
              fi

              # If it's another error, stop retrying
              echo "❌ Failed to enable auto-merge with non-retriable error: $OUTPUT"
              exit $EXIT_CODE
            fi
          done

          if [ $SUCCESS -eq 0 ]; then
            echo "❌ Failed to enable auto-merge after $MAX_RETRIES attempts."
            echo "Last error: $OUTPUT"
            exit 1
          fi