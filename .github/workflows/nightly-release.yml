name: Nightly Release

on:
  schedule:
    - cron: '0 2 * * 1' # Every Monday at 02:00 UTC
  workflow_dispatch: # Allow manual trigger for testing

permissions:
  contents: write
  packages: write

jobs:
  nightly-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes since last release
        id: check_changes
        run: |
          # Get latest tag
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$latest_tag" ]; then
            echo "No tags found. Initial release."
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if there are commits since the latest tag
          # We compare HEAD with the tag
          diff_count=$(git rev-list "$latest_tag"..HEAD --count)

          if [ "$diff_count" -gt "0" ]; then
            echo "Found $diff_count commits since $latest_tag"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No changes since $latest_tag"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Calculate Next Version
        if: steps.check_changes.outputs.has_changes == 'true'
        id: version
        run: |
          # Get current version from tag (strip 'v')
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
          current_version=${latest_tag#v}
          echo "Current Tag Version: $current_version"

          # Calculate new version (Force prerelease)
          new_version=$(python3 scripts/generate_version.py --current "$current_version" --type nightly)
          echo "Calculated Nightly Version: $new_version"

          echo "NEW_VERSION=$new_version" >> $GITHUB_ENV
          echo "version=$new_version" >> $GITHUB_OUTPUT

      - name: Update Version Files & Commit
        if: steps.check_changes.outputs.has_changes == 'true'
        id: commit
        run: |
          # Configure Git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Update frontend/package.json
          # Using npm version to update file without creating a git tag yet
          cd frontend
          npm version ${{ env.NEW_VERSION }} --no-git-tag-version
          cd ..

          # Update backend/config.py
          # Replace version
          sed -i 's/os.getenv("BACKEND_VERSION", "[^"]*")/os.getenv("BACKEND_VERSION", "${{ env.NEW_VERSION }}")/' backend/config.py
          # Replace release type
          sed -i 's/os.getenv("RELEASE_TYPE", "[^"]*")/os.getenv("RELEASE_TYPE", "nightly")/' backend/config.py

          # Update frontend/src/config.js
          sed -i 's/export const APP_RELEASE_TYPE = "[^"]*";/export const APP_RELEASE_TYPE = "nightly";/' frontend/src/config.js

          # Commit and Push
          git add frontend/package.json backend/config.py frontend/src/config.js
          git commit -m "chore(release): bump version to ${{ env.NEW_VERSION }} [skip ci]"
          git push

          # Get the new commit SHA
          echo "commit_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Create Nightly Release
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.NEW_VERSION }}
          name: Nightly v${{ env.NEW_VERSION }}
          target_commitish: ${{ steps.commit.outputs.commit_sha }}
          draft: false
          prerelease: true
          generate_release_notes: true
