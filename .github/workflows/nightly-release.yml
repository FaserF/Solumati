name: Nightly Release

on:
  schedule:
    - cron: '0 2 * * 1' # Every Monday at 02:00 UTC
  workflow_dispatch: # Allow manual trigger for testing

permissions:
  contents: write
  packages: write

jobs:
  nightly-release:
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.check_changes.outputs.has_changes }}
      version: ${{ steps.version.outputs.version }}
      commit_sha: ${{ steps.commit.outputs.commit_sha }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Check for changes since last release
        id: check_changes
        run: |
          # Get latest tag
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          if [ -z "$latest_tag" ]; then
            echo "No tags found. Initial release."
            echo "has_changes=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Check if there are commits since the latest tag
          # We compare HEAD with the tag
          diff_count=$(git rev-list "$latest_tag"..HEAD --count)

          if [ "$diff_count" -gt "0" ]; then
            echo "Found $diff_count commits since $latest_tag"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          else
            echo "No changes since $latest_tag"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          fi

      - name: Set up Python
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'

      - name: Calculate Next Version
        if: steps.check_changes.outputs.has_changes == 'true'
        id: version
        run: |
          # Get current version from tag (strip 'v')
          latest_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "0.0.0")
          current_version=${latest_tag#v}
          echo "Current Tag Version: $current_version"

          # Calculate new version (Force prerelease)
          new_version=$(python3 scripts/generate_version.py --current "$current_version" --type nightly)
          echo "Calculated Nightly Version: $new_version"

          echo "NEW_VERSION=$new_version" >> $GITHUB_ENV
          echo "version=$new_version" >> $GITHUB_OUTPUT

      - name: Update Version Files & Commit
        if: steps.check_changes.outputs.has_changes == 'true'
        id: commit
        run: |
          # Configure Git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Update frontend/package.json
          # Using npm version to update file without creating a git tag yet
          cd frontend
          npm version ${{ env.NEW_VERSION }} --no-git-tag-version --allow-same-version
          cd ..

          # Update backend/app/core/config.py
          # Replace version
          sed -i 's/os.getenv("BACKEND_VERSION", "[^"]*")/os.getenv("BACKEND_VERSION", "${{ env.NEW_VERSION }}")/' backend/app/core/config.py
          # Replace release type
          sed -i 's/os.getenv("RELEASE_TYPE", "[^"]*")/os.getenv("RELEASE_TYPE", "nightly")/' backend/app/core/config.py

          # Update frontend/src/config.js
          sed -i 's/export const APP_RELEASE_TYPE = "[^"]*";/export const APP_RELEASE_TYPE = "nightly";/' frontend/src/config.js

          # Commit and Push
          git add frontend/package.json backend/app/core/config.py frontend/src/config.js
          git commit -m "chore(release): bump version to ${{ env.NEW_VERSION }} [skip ci]"
          git push

          # Get the new commit SHA
          echo "commit_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Set up Python for Release Body
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Generate Initial Release Body
        if: steps.check_changes.outputs.has_changes == 'true'
        id: release_body
        env:
          NEW_VERSION: ${{ env.NEW_VERSION }}
        run: |
          # Generate download buttons HTML using Python to avoid YAML parsing issues
          python3 << 'PYTHON_SCRIPT'
          import os
          from datetime import datetime

          new_version = os.environ.get('NEW_VERSION', 'unknown')

          # Build HTML using string concatenation to avoid YAML parser seeing < characters
          downloads_html = "## üì• Downloads\n\n"
          downloads_html += "<div style=\"background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 24px; border-radius: 12px; margin: 24px 0;\">\n"
          downloads_html += "  <div style=\"margin-bottom: 16px;\">\n"
          downloads_html += "    <div style=\"display: inline-block; margin: 8px;\">\n"
          downloads_html += "      <div style=\"background: #2196f3; color: white; padding: 8px 16px; border-radius: 6px; font-weight: 600; font-size: 0.9em;\">\n"
          downloads_html += "        ‚è≥ Build Status: Building...\n"
          downloads_html += "      </div>\n"
          downloads_html += "    </div>\n"
          downloads_html += "  </div>\n"
          downloads_html += "  <div style=\"display: flex; flex-wrap: wrap; gap: 8px; align-items: center;\">\n"
          downloads_html += "    <div style=\"display: inline-block; margin: 8px;\">\n"
          downloads_html += "      <div style=\"background: #e0e0e0; color: #757575; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; cursor: not-allowed; opacity: 0.6;\">\n"
          downloads_html += "        <span style=\"font-size: 1.2em;\">ü§ñ</span>\n"
          downloads_html += "        <span>Android APK</span>\n"
          downloads_html += "        <span style=\"font-size: 0.85em; opacity: 0.7;\">(‚è≥ Building)</span>\n"
          downloads_html += "      </div>\n"
          downloads_html += "    </div>\n"
          downloads_html += "    <div style=\"display: inline-block; margin: 8px;\">\n"
          downloads_html += "      <div style=\"background: #e0e0e0; color: #757575; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; cursor: not-allowed; opacity: 0.6;\">\n"
          downloads_html += "        <span style=\"font-size: 1.2em;\">ü™ü</span>\n"
          downloads_html += "        <span>Windows MSIX</span>\n"
          downloads_html += "        <span style=\"font-size: 0.85em; opacity: 0.7;\">(‚è≥ Building)</span>\n"
          downloads_html += "      </div>\n"
          downloads_html += "    </div>\n"
          downloads_html += "    <div style=\"display: inline-block; margin: 8px;\">\n"
          downloads_html += "      <div style=\"background: #e0e0e0; color: #757575; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; cursor: not-allowed; opacity: 0.6;\">\n"
          downloads_html += "        <span style=\"font-size: 1.2em;\">üçé</span>\n"
          downloads_html += "        <span>iOS IPA</span>\n"
          downloads_html += "        <span style=\"font-size: 0.85em; opacity: 0.7;\">(‚è≥ Building)</span>\n"
          downloads_html += "      </div>\n"
          downloads_html += "    </div>\n"
          downloads_html += "    <div style=\"display: inline-block; margin: 8px;\">\n"
          downloads_html += "      <div style=\"background: #e0e0e0; color: #757575; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; cursor: not-allowed; opacity: 0.6;\">\n"
          downloads_html += "        <span style=\"font-size: 1.2em;\">üê≥</span>\n"
          downloads_html += "        <span>Docker Image</span>\n"
          downloads_html += "        <span style=\"font-size: 0.85em; opacity: 0.7;\">(‚è≥ Building)</span>\n"
          downloads_html += "      </div>\n"
          downloads_html += "    </div>\n"
          downloads_html += "  </div>\n"
          downloads_html += "  <div style=\"margin-top: 16px; font-size: 0.9em; color: #666;\">\n"
          downloads_html += "    <p><strong>Last updated:</strong> " + datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S') + " UTC</p>\n"
          downloads_html += "    <p><em>Build artifacts are automatically uploaded as they become available.</em></p>\n"
          downloads_html += "  </div>\n"
          downloads_html += "</div>"

          initial_body = f"## Nightly Release v{new_version}\n\n"
          initial_body += "This is an automated nightly build. Use with caution.\n\n"
          initial_body += downloads_html

          with open('RELEASE_BODY.md', 'w', encoding='utf-8') as f:
              f.write(initial_body)
          PYTHON_SCRIPT

          echo "body_path=RELEASE_BODY.md" >> $GITHUB_OUTPUT

      - name: Create Nightly Release
        if: steps.check_changes.outputs.has_changes == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.NEW_VERSION }}
          name: Nightly v${{ env.NEW_VERSION }}
          target_commitish: ${{ steps.commit.outputs.commit_sha }}
          body_path: ${{ steps.release_body.outputs.body_path }}
          draft: false
          prerelease: true

  # Build jobs for nightly release
  build-push-docker:
    needs: nightly-release
    if: needs.nightly-release.outputs.has_changes == 'true'
    uses: ./.github/workflows/docker-publish.yml
    with:
      version: ${{ needs.nightly-release.outputs.version }}
    permissions:
      contents: read
      packages: write

  build-android:
    needs: nightly-release
    if: needs.nightly-release.outputs.has_changes == 'true'
    uses: ./.github/workflows/android-release.yml
    with:
      tag_name: v${{ needs.nightly-release.outputs.version }}
      ref: ${{ needs.nightly-release.outputs.commit_sha }}
    secrets: inherit

  build-ios:
    needs: nightly-release
    if: needs.nightly-release.outputs.has_changes == 'true'
    uses: ./.github/workflows/ios-release.yml
    with:
      tag_name: v${{ needs.nightly-release.outputs.version }}
      ref: ${{ needs.nightly-release.outputs.commit_sha }}
    secrets: inherit

  build-windows:
    needs: nightly-release
    if: needs.nightly-release.outputs.has_changes == 'true'
    uses: ./.github/workflows/windows-release.yml
    with:
      tag_name: v${{ needs.nightly-release.outputs.version }}
      ref: ${{ needs.nightly-release.outputs.commit_sha }}
    secrets: inherit

  # Monitor and update release buttons
  update-release-buttons:
    needs: [nightly-release, build-push-docker, build-android, build-ios, build-windows]
    if: always() && needs.nightly-release.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install Dependencies
        run: |
          pip install PyGithub

      - name: Determine Overall Build Status
        id: build_status
        run: |
          STATUS="success"
          if [ "${{ needs.build-android.result }}" == "failure" ] || \
             [ "${{ needs.build-ios.result }}" == "failure" ] || \
             [ "${{ needs.build-windows.result }}" == "failure" ] || \
             [ "${{ needs.build-push-docker.result }}" == "failure" ]; then
            STATUS="failure"
          elif [ "${{ needs.build-android.result }}" == "cancelled" ] || \
               [ "${{ needs.build-ios.result }}" == "cancelled" ] || \
               [ "${{ needs.build-windows.result }}" == "cancelled" ] || \
               [ "${{ needs.build-push-docker.result }}" == "cancelled" ]; then
            STATUS="cancelled"
          elif [ "${{ needs.build-android.result }}" != "success" ] || \
               [ "${{ needs.build-ios.result }}" != "success" ] || \
               [ "${{ needs.build-windows.result }}" != "success" ] || \
               [ "${{ needs.build-push-docker.result }}" != "success" ]; then
            STATUS="running"
          fi
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "Build Status: $STATUS"

      - name: Update Release Notes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          TAG_NAME: v${{ needs.nightly-release.outputs.version }}
          BUILD_STATUS: ${{ steps.build_status.outputs.status }}
        run: |
          python .github/scripts/update-release-buttons.py
