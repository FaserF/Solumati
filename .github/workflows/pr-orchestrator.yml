name: PR Orchestrator

on:
  pull_request_target:
    types: [opened, synchronize, reopened, closed]
  workflow_run:
    workflows: ["Main CI"]
    types:
      - completed

permissions:
  pull-requests: write
  contents: write
  issues: write

jobs:
  # 1. AUTO-LABEL (Triggers on PR events)
  auto-label:
    name: Auto Labeling
    if: github.event_name == 'pull_request_target' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v45

      - name: Determine labels
        id: labels
        run: |
          labels=""
          files="${{ steps.changed-files.outputs.all_changed_files }}"

          if echo "$files" | grep -qE "(^frontend/|frontend/)"; then labels="${labels}frontend,"; fi
          if echo "$files" | grep -qE "(^backend/|backend/)"; then labels="${labels}backend,"; fi
          if echo "$files" | grep -qE "(\.github/ios/|\.github/windows/Solumati/)"; then labels="${labels}ios,"; fi
          if echo "$files" | grep -qE "(\.github/scripts/build-apk|android)"; then labels="${labels}android,"; fi
          if echo "$files" | grep -qE "(\.github/windows/|\.github/scripts/build-windows)"; then labels="${labels}windows,"; fi
          if echo "$files" | grep -qE "(Dockerfile|docker-compose\.yml|\.github/workflows/docker)"; then labels="${labels}docker,"; fi
          if echo "$files" | grep -qE "(^docs/|README\.md|CHANGELOG\.md)"; then labels="${labels}documentation,"; fi
          if echo "$files" | grep -qE "(\.github/workflows/|\.github/scripts/)"; then labels="${labels}ci/cd,"; fi
          if echo "$files" | grep -qE "(\.json|\.yaml|\.yml|\.toml|\.ini|\.conf)"; then
            if ! echo "$files" | grep -qE "(\.github/workflows/)"; then labels="${labels}configuration,"; fi
          fi
          if echo "$files" | grep -qE "(test/|\.test\.|\.spec\.|e2e/)"; then labels="${labels}tests,"; fi

          labels=$(echo "$labels" | sed 's/,$//')
          echo "labels=$labels" >> $GITHUB_OUTPUT

      - name: Add labels to PR
        if: steps.labels.outputs.labels != ''
        uses: actions/github-script@v7
        with:
          script: |
            const labels = '${{ steps.labels.outputs.labels }}'.split(',').filter(l => l.trim() !== '');
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: ${{ github.event.pull_request.number }},
                labels: labels,
              });
            }

  # 2. PROCESS RESULTS (Auto-Label on Success, Feedback on Failure, Auto-Merge)
  process-results:
    if: github.event_name == 'workflow_run'
    runs-on: ubuntu-latest
    steps:
      - name: Handle CI Result
        uses: actions/github-script@v7
        with:
          script: |
            const run = context.payload.workflow_run;
            const conclusion = run.conclusion;
            const pr = run.pull_requests[0];

            if (!pr) return;

            if (conclusion === 'success') {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['verified', 'quality-gate-passed']
              });

              // Auto-merge for Admins
              const { data: prData } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });

              const ADMINS = ['FaserF', 'SolumatiBot'];
              if (ADMINS.includes(prData.user.login)) {
                try {
                  await github.rest.pulls.merge({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: pr.number,
                    merge_method: 'squash'
                  });
                } catch (e) {
                  console.log("Merge failed: " + e.message);
                }
              }
            } else {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['tests-failed']
              });

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: "‚ùå **Checks Failed**\n\nThe automation detected issues. Please check the 'Main CI' action logs for details."
              });
            }

  # 3. THANK YOU MESSAGE (On Merge)
  thank-contributor:
    if: github.event_name == 'pull_request_target' && github.event.action == 'closed' && github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Say Thanks
        uses: actions/github-script@v7
        with:
          script: |
            const ADMINS = ['FaserF', 'SolumatiBot'];
            const author = context.payload.pull_request.user.login;

            if (!ADMINS.includes(author) && !author.endsWith('[bot]')) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: `üéâ **Merged!**\n\nThank you @${author} for your contribution! ‚ù§Ô∏è`
              });
            }
