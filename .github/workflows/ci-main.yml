name: Main CI

on:
  push:
    branches: [ "main", "dev" ]
  pull_request:
    branches: [ "main", "dev" ]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # 1. INTELLIGENT CHANGE DETECTION
  changes:
    runs-on: ubuntu-latest
    outputs:
      backend: ${{ steps.filter.outputs.backend }}
      frontend: ${{ steps.filter.outputs.frontend }}
      docker: ${{ steps.filter.outputs.docker }}
      e2e: ${{ steps.filter.outputs.e2e }}
      docs: ${{ steps.filter.outputs.docs }}
      ci: ${{ steps.filter.outputs.ci }}
      dependencies: ${{ steps.filter.outputs.dependencies }}
      any_code: ${{ steps.filter.outputs.any_code }}
    steps:
      - uses: actions/checkout@v6
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            backend:
              - 'backend/**'
              - '.github/workflows/backend-ci.yml'
              - 'requirements.txt'
            frontend:
              - 'frontend/**'
              - '.github/workflows/frontend-ci.yml'
            docker:
              - 'docker-compose.yml'
              - 'Dockerfile'
              - '.github/workflows/docker-ci.yml'
              - 'backend/**'
            e2e:
              - 'frontend/**'
              - 'backend/**'
              - '.github/workflows/e2e-tests.yml'
            docs:
              - 'docs/**'
              - '**/*.md'
              - '!CHANGELOG.md'
            ci:
              - '.github/**'
            dependencies:
              - '**/requirements.txt'
              - '**/package.json'
              - '**/package-lock.json'
            any_code:
              - 'backend/**'
              - 'frontend/**'

  # 2. SUB-WORKFLOWS (Conditional)

  link-check:
    name: Link Checker
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: lycheeverse/lychee-action@v2.7.0
        with:
          args: --config lychee.toml --exclude-all-private './**/*.md' './docs/**/*.md' './frontend/src/**/*.jsx'
          fail: false

  backend:
    needs: changes
    if: ${{ needs.changes.outputs.backend == 'true' }}
    uses: ./.github/workflows/backend-ci.yml

  frontend:
    needs: changes
    if: ${{ needs.changes.outputs.frontend == 'true' }}
    uses: ./.github/workflows/frontend-ci.yml

  docker:
    needs: changes
    if: ${{ needs.changes.outputs.docker == 'true' }}
    uses: ./.github/workflows/docker-ci.yml

  e2e:
    needs: [changes, backend, frontend]
    # Run E2E if backend OR frontend changed
    if: ${{ needs.changes.outputs.e2e == 'true' }}
    uses: ./.github/workflows/e2e-tests.yml

  # 3. CI SUMMARY
  ci-summary:
    name: CI Summary
    needs: [changes, link-check, backend, frontend, docker, e2e]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Generate Summary
        run: |
          echo "## üìä CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîç Detected Changes" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Changed |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| Backend | ${{ needs.changes.outputs.backend == 'true' && '‚úÖ Yes' || '‚è≠Ô∏è No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.changes.outputs.frontend == 'true' && '‚úÖ Yes' || '‚è≠Ô∏è No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker | ${{ needs.changes.outputs.docker == 'true' && '‚úÖ Yes' || '‚è≠Ô∏è No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E | ${{ needs.changes.outputs.e2e == 'true' && '‚úÖ Yes' || '‚è≠Ô∏è No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docs | ${{ needs.changes.outputs.docs == 'true' && '‚úÖ Yes' || '‚è≠Ô∏è No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| CI Config | ${{ needs.changes.outputs.ci == 'true' && '‚úÖ Yes' || '‚è≠Ô∏è No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependencies | ${{ needs.changes.outputs.dependencies == 'true' && '‚úÖ Yes' || '‚è≠Ô∏è No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üèÉ Workflow Execution" >> $GITHUB_STEP_SUMMARY
          echo "| Workflow | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Link Check | ${{ needs.link-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Backend CI | ${{ needs.backend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend CI | ${{ needs.frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Docker CI | ${{ needs.docker.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| E2E Tests | ${{ needs.e2e.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: Check for Failures
        if: contains(needs.*.result, 'failure')
        run: |
          echo "‚ùå One or more checks failed!"
          exit 1
