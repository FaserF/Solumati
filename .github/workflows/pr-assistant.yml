name: PR Assistant

on:
  workflow_run:
    workflows: ["PR Quality Gate"]
    types:
      - completed
  pull_request_target:
    types:
      - closed

permissions:
  pull-requests: write
  contents: write
  issues: write

jobs:
  # 1. PROCESS RESULTS (Auto-Label, Feedback, Auto-Merge)
  process-results:
    if: ${{ github.event_name == 'workflow_run' }}
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/github-script@v7
        with:
          script: |
            // Get the PR number associated with the Quality Gate run
            let allArtifacts = await github.rest.actions.listWorkflowRunArtifacts({
               owner: context.repo.owner,
               repo: context.repo.repo,
               run_id: context.payload.workflow_run.id,
            });
            // (In a real scenario we'd pass the PR number via artifacts,
            // but here we simplify by assuming we can look it up or purely trust the status)

            let conclusion = context.payload.workflow_run.conclusion;
            let pr = context.payload.workflow_run.pull_requests[0];

            if (!pr) {
              console.log("No PR found for this run (maybe push to branch?)");
              return;
            }

            if (conclusion === 'success') {
              console.log("‚úÖ Quality Gate Passed!");

              // 1. Add "Verified" Label
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['verified', 'quality-gate-passed']
              });

              // 2. CHECK IF ADMIN -> AUTO MERGE
              // We need to fetch the PR details to see the author
              let prDetails = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number
              });

              let author = prDetails.data.user.login;
              // Add your admin usernames here
              const ADMINS = ['FaserF', 'SolumatiBot'];

              if (ADMINS.includes(author)) {
                  console.log(`üöÄ Author ${author} is Admin. Auto-merging...`);
                  try {
                      await github.rest.pulls.merge({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          pull_number: pr.number,
                          merge_method: 'squash'
                      });
                  } catch (e) {
                      console.log("Auto-merge failed (maybe conflicts?): " + e);
                  }
              } else {
                  console.log(`Author ${author} is not Admin. Ready for manual review.`);
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number,
                    body: "‚úÖ **Quality Gate Passed!**\n\nYour code has passed all tests and link checks. A maintainer will review it shortly."
                  });
              }

            } else {
              console.log("‚ùå Quality Gate Failed!");

              try {
                  // Fetch the specific jobs that failed to give better feedback
                  const { data: runJobs } = await github.rest.actions.listJobsForWorkflowRun({
                     owner: context.repo.owner,
                     repo: context.repo.repo,
                     run_id: context.payload.workflow_run.id
                  });

                  let failedJobs = runJobs.jobs.filter(j => j.conclusion === 'failure');
                  let message = "‚ùå **Checks Failed**\n\nThe automation detected issues in the following QA checks:\n\n";

                  failedJobs.forEach(job => {
                      // job.name is now human readable (e.g. "Link Checker")
                      message += `### üî¥ [${job.name}](${job.html_url})\n`;
                      if(job.steps) {
                          job.steps.filter(s => s.conclusion === 'failure').forEach(step => {
                             message += `- **Step: ${step.name}** failed.\n`;
                          });
                      }
                      message += "\n";
                  });

                  message += "---\n> **Action Required**:\n> 1. Click the links above to see the error details.\n> 2. Fix the issues locally.\n> 3. Push your changes.";

                  await github.rest.issues.addLabels({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number,
                    labels: ['tests-failed']
                  });

                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number,
                    body: message
                  });

              } catch(err) {
                  console.log("Error generating detailed report: " + err);
                  // Fallback to simple message
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: pr.number,
                    body: "‚ùå **Checks Failed**\n\nThe automation detected issues. Please check the 'PR Quality Gate' action logs for details."
                  });
              }
            }

  # 2. THANK YOU MESSAGE (On Merge)
  thank-contributor:
    if: ${{ github.event.pull_request.merged == true }}
    runs-on: ubuntu-latest
    steps:
      - name: Say Thanks
        uses: actions/github-script@v7
        with:
          script: |
            const ADMINS = ['FaserF', 'SolumatiBot'];
            const author = context.payload.pull_request.user.login;

            if (!ADMINS.includes(author) && !author.endsWith('[bot]')) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.payload.pull_request.number,
                  body: `üéâ **Merged!**\n\nThank you @${author} for your contribution to Solumati! Your effort helps make this project better for everyone. ‚ù§Ô∏è`
                });
            }
