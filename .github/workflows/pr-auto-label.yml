name: PR Auto Label

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: read

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v44
        with:
          files: |
            **/*

      - name: Determine labels based on changed files
        id: labels
        run: |
          labels=""

          # Check for frontend changes
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -qE "(^frontend/|frontend/)"; then
            labels="${labels}frontend,"
          fi

          # Check for backend changes
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -qE "(^backend/|backend/)"; then
            labels="${labels}backend,"
          fi

          # Check for iOS changes
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -qE "(\.github/ios/|\.github/windows/Solumati/)"; then
            labels="${labels}ios,"
          fi

          # Check for Android changes
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -qE "(\.github/scripts/build-apk|android)"; then
            labels="${labels}android,"
          fi

          # Check for Windows changes
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -qE "(\.github/windows/|\.github/scripts/build-windows)"; then
            labels="${labels}windows,"
          fi

          # Check for Docker changes
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -qE "(Dockerfile|docker-compose\.yml|\.github/workflows/docker)"; then
            labels="${labels}docker,"
          fi

          # Check for documentation changes
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -qE "(^docs/|README\.md|CHANGELOG\.md)"; then
            labels="${labels}documentation,"
          fi

          # Check for CI/CD changes
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -qE "(\.github/workflows/|\.github/scripts/)"; then
            labels="${labels}ci/cd,"
          fi

          # Check for configuration changes
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -qE "(\.json|\.yaml|\.yml|\.toml|\.ini|\.conf)"; then
            if ! echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -qE "(\.github/workflows/)"; then
              labels="${labels}configuration,"
            fi
          fi

          # Check for test changes
          if echo "${{ steps.changed-files.outputs.all_changed_files }}" | grep -qE "(test/|\.test\.|\.spec\.|e2e/)"; then
            labels="${labels}tests,"
          fi

          # Remove trailing comma
          labels=$(echo "$labels" | sed 's/,$//')

          echo "labels=$labels" >> $GITHUB_OUTPUT
          echo "Detected labels: $labels"

      - name: Add labels to PR
        if: steps.labels.outputs.labels != ''
        uses: actions/github-script@v8
        with:
          script: |
            const labels = '${{ steps.labels.outputs.labels }}'.split(',').filter(l => l.trim() !== '');

            if (labels.length > 0) {
              console.log(`Adding labels: ${labels.join(', ')}`);

              // Get existing labels
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
              });

              const existingLabels = pr.labels.map(l => l.name);
              const labelsToAdd = labels.filter(l => !existingLabels.includes(l));

              if (labelsToAdd.length > 0) {
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: labelsToAdd,
                });
                console.log(`✅ Added labels: ${labelsToAdd.join(', ')}`);
              } else {
                console.log('ℹ️  All labels already exist on PR');
              }
            } else {
              console.log('ℹ️  No labels to add');
            }
